<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>내 페이지</title>
    <link rel="stylesheet" href="../css/nav.css">
    <link rel="stylesheet" href="../css/modal.css">
    <link rel="stylesheet" href="../css/registerProduct.css">
    <link rel="stylesheet" href="../css/memberP_review.css">
    <style>
        /* 스타일 내용은 그대로 유지 */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            height: 100vh;
        }
        .sidebar {
            width: 200px;
            background: #fff;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            margin-top: 50px;
            height: calc(100% - 20px);
            overflow-y: auto;
        }
        .sidebar h2 {
            font-size: 18px;
            margin-top: 0;
        }
        .sidebar a {
            display: block;
            padding: 10px;
            color: #3b5998;
            text-decoration: none;
            border-radius: 5px;
            margin: 5px 0;
        }
        .sidebar a:hover {
            background: #f0f0f0;
        }
        .container {
            flex: 1;
            max-width: 1200px;
            margin: 20px;
            margin-top: 60px;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            height: calc(100% - 30px);
            overflow-y: auto;
        }
        .section {
            margin: 20px 0;
        }
        .section h2 {
            border-bottom: 2px solid #3b5998;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #3b5998;
            color: white;
        }
        .btn {
            background: #3b5998;
            color: #fff;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn:hover {
            background: #2d4373;
        }
        .add-design, .remove-design {
            display: inline-block;
            width: 50px;
            height: 38px;
            background-color: #007bff;
            color: white;
            text-align: center;
            line-height: 38px;
            cursor: pointer;
            border-radius: 4px;
            margin-left: 10px;
        }
        .remove-design {
            background-color: #dc3545;
        }
        .design-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .account_num_display {
            display: none;
        }
        .flex {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;

        }
        .space_between {
            display: flex;
            justify-content: space-between; /* 좌우로 요소 분배 */
            align-items: center; /* 세로 중앙 정렬 */
        }
        .refund_information {
            padding: 8px 12px;
            font-size: 16px;
            background-color: #007bff; /* 버튼 색상 */
            color: #fff; /* 텍스트 색상 */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .refund_information:hover {
            background-color: #0056b3; /* 호버 시 색상 */
        }
        .flex_btn{
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .wishlist-item {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 10px;
            width: 200px;
            overflow: hidden;
            text-align: center;
            transition: transform 0.3s ease;
        }
        .wishlist-item:hover {
            transform: translateY(-10px);
        }
        .wishlist-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid #eee;
        }
        .wishlist-item .product-info {
            padding: 15px;
        }
        .wishlist-item h3 {
            font-size: 18px;
            margin: 10px 0;
            color: #333;
        }
        .wishlist-item p {
            color: #777;
            font-size: 16px;
        }
        .remove-btn {
            background-color: #ff4c4c;
            color: white;
            border: none;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }
        .remove-btn:hover {
            background-color: #e03e3e;
        }

        .img img{
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div th:replace="include/nav2 :: navbar2"></div>
    <div class="flex">

        <div class="sidebar">
            <h2>개인관리</h2>
            <a href="#profile" onclick="showSection('profile')">회원 정보</a>
            <a href="#orders" onclick="showSection('orders')">주문 내역</a>
            <a href="#wishlist" onclick="showSection('wishlist')">찜 목록</a>
            <a href="#review" onclick="showSection('review')">리뷰쓰기</a>
            <a href="#qnaView" onclick="showSection('qnaView')">문의확인</a>
            <p><hr></p><br>
            <h2>판매관리</h2>
            <a href="#product_register" onclick="showSection('product_register')">상품등록</a>
            <a href="#productOrder" onclick="showSection('productOrder')">판매관리</a>
            <a href="#reviewReply" onclick="showSection('reviewReply')">리뷰관리</a>
            <a href="#qna" onclick="showSection('qna')">문의관리</a>
            <p><hr></p><br>
        </div>

        <div class="container">
            <div class="section" id="profile" style="display: none;">
                <h2>회원 정보</h2>
                <p>닉네임: <span id="userName" th:text="${mid}">홍길동</span></p>
                <p>닉네임: <span id="level" th:text="${level_name}">등급</span></p>
                <p>이메일: <span id="userEmail" th:text="${email}">example@example.com</span></p>
                <p>계좌번호: <span id="userAccount_num" th:text="${account_num}">352-0869-2631-53</span></p>
                <form name="accountForm" id="accountForm" method="post" th:action="@{/member/editAccount_num}">
                    <div class="account_num_display">
                        <input type="text" id="account_num" name="account_num">
                        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                        <button type="button" class="btn" onclick="editAccount_num()">등록/수정하기</button>
                    </div>
                </form>
                <button class="btn" type="button" onclick="editProfile()">계좌번호등록/수정</button>
                <button class="btn" type="button" id="openPwdSetModalBtn" onclick="openPwdSetModal()">비밀번호 수정</button>
            </div>

            <!-- 비밀번호 수정 모달창 -->
            <!-- Modal Structure -->
            <div id="pwdSetModal" class="modal">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <form id="pwdSetModalForm" method="post" th:action="@{/member/pwdSet}">
                        <h2 id="modalContent">비밀번호 재설정</h2>
                        <p><span id="pwd1Msg" class="red"></span></p>
                        <input type="password" placeholder="새로운 비밀번호" id="pwd1" name="pwd1"/>
                        <p><span id="pwd2Msg" class="red"></span></p>
                        <input type="password" placeholder="비밀번호 확인" id="pwd2" name="pwd2"/>
                        <input type="hidden" name="pwd" id="pwd" />
                        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                        <button class="action-btn" onclick="pwdSet()">확인</button>
                    </form>
                </div>
            </div>

            <div class="section" id="orders" style="display: none;">
                <div class="space_between">
                    <h2 style="border-bottom: none;">주문 내역</h2>
<!--                    <button class="refund_information">환불정보</button>-->
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>주문 번호</th>
                            <th>상품명</th>
                            <th>가격</th>
                            <th>수량</th>
                            <th>주문일</th>
                            <th>상태</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody th:each="sectionOrdersList, sectionOrdersListStat : ${sectionOrdersList}">
                        <tr>
                            <td th:text="${sectionOrdersList.id}">주문번호</td>
                            <td>
                                [<span th:text="${sectionOrdersList.design}"></span>]<p th:text="${sectionOrdersList.productName}"></p>
                            </td>
                            <td th:text="${sectionOrdersList.price}">주문가격</td>
                            <td th:text="${sectionOrdersList.amount}">구입수량</td>
                            <td th:text="${sectionOrdersList.order_date}">구입날짜</td>
                            <td th:id="'orderStatus_' + ${sectionOrdersListStat.index}" th:text="${sectionOrdersList.orderStatus}">배송전/배송중/결정완료/환불중</td>
                            <td>
                                <button th:if="${sectionOrdersList.orderStatus} == '배송중'"
                                        class="btn" th:productOrderId="${sectionOrdersList.id}" th:productId="${sectionOrdersList.product_id}" th:amount="${sectionOrdersList.amount}"
                                        onclick="completeOrder(this.getAttribute('productOrderId'), this.getAttribute('productId'), this.getAttribute('amount'))">
                                    구매결정
                                </button>
                                <button th:if="${sectionOrdersList.orderStatus} == '환불거부'"
                                        class="btn" th:productOrderId="${sectionOrdersList.id}"
                                        th:index="${sectionOrdersListStat.index}"
                                        onclick="refundRefuseReason(this.getAttribute('productOrderId'), this.getAttribute('index'))">
                                    환불거절사유
                                </button>
                                <button th:if="${sectionOrdersList.orderStatus} == '배송중'"
                                        class="btn" th:productOrderId="${sectionOrdersList.id}"
                                        th:index="${sectionOrdersListStat.index}"
                                        onclick="refundRequest(this.getAttribute('productOrderId'), this.getAttribute('index'))">
                                    환불신청
                                </button>
                                <p th:if="${sectionOrdersList.orderStatus} == '배송완료'">배송완료</p>
                                <p th:if="${sectionOrdersList.orderStatus} == '환불처리중'">환불처리중</p>
                                <p th:if="${sectionOrdersList.orderStatus} == '배송전'">배송전</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 환불요청시 요청사유 나오는 창 -->
            <div id="refundModal" class="modal" style="display:none;">
                <span class="close-btn">&times;</span>
                <form id="sendRefundForm" method="post" th:action="@{/member/refund}">
                    <div class="modal-content">
                        <p>환불사유</p>
                        <textarea rows="7" cols="40" maxlength="50" oninput="updateCharCount()" id="refundTextarea" name="refundTextarea"></textarea>
                        <p>남은 글자 수: <span id="charCount">50</span></p>
                        <button class="btn" onclick="sendRefund()">환불</button>
                        <button class="closeModal btn" type="button">닫기</button>
                    </div>
                    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                    <input type="hidden" name="productOrderId">
                </form>
            </div>

            <div class="section" id="wishlist" style="display: none;">
                <h2>찜한상품</h2>
                <div class="flex">
                    <div class="wishlist-container" th:each="wishListProduct : ${wishListProduct}">
                        <div class="wishlist-item">
                            <a th:href="@{/product/{product_name}/{id}/{productId}(product_name=${wishListProduct.product_name}, id=${wishListProduct.sub_category_id}, productId=${wishListProduct.id})}">
                                <img th:src=@{/img/product_img/{img1}(img1=${wishListProduct.img1})} alt="Product Image">
                            </a>
                            <div class="product-info">
                                <h3 th:text="${wishListProduct.product_name}">상품 이름</h3>
                                <p th:text="${wishListProduct.price}">가격: 20,000원</p>
                                <button class="remove-btn" th:productId="${wishListProduct.id}" onclick="deleteWishList(this.getAttribute('productId'))">삭제</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section" id="review" style="display:none;">
                <h2>리뷰쓰기</h2>
                <table>
                    <tr>
                        <th>이미지</th>
                        <th>상품정보</th>
                        <th>구입가격</th>
                        <th>비고</th>
                    </tr>
                    <tr th:each="orderProductList : ${orderProductList}">
                        <td class="img">
                            <img th:src=@{/img/product_img/{img1}(img1=${orderProductList.img1})} alt="Product Image">
                        </td>
                        <td>
                            <h3 th:text="${orderProductList.product_name}">상품 이름</h3>
                            <p th:text="${orderProductList.orderDesign}">구입한 디자인</p>
                        </td>
                        <td th:text="${orderProductList.getFormattedOrderPrice}">구입한 가격</td>
                        <td>
                            <button class="btn"
                                    th:if="${orderProductList.reviewStatus == '리뷰전'}"
                                    th:reviewProductOrderId="${orderProductList.productOrderId}"
                                    onclick="openReviewWriteModal(this.getAttribute('reviewProductOrderId'))">
                                리뷰쓰기
                            </button>
                            <button class="btn"
                                    th:if="${orderProductList.reviewStatus == '리뷰완료'}"
                                    th:reviewProductOrderId="${orderProductList.productOrderId}"
                                    onclick="befOpenReviewViewModal(this.getAttribute('reviewProductOrderId'))">
                                작성리뷰보기
                            </button>
                            <button class="btn"
                                    th:if="${orderProductList.reviewStatus == '리뷰완료'} and ${orderProductList.reply == 1}"
                                    th:reviewProductOrderId="${orderProductList.productOrderId}"
                                    onclick="reviewReplyView(this.getAttribute('reviewProductOrderId'))">
                                리뷰답글보기
                            </button>
                        </td>
                    </tr>
                </table>
            </div>

            <div id="reviewReplyViewModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div id="reviewReplyViewModalContent"></div>
                    <button class="btn reviewReplyViewModalClose">닫기</button>
                </div>
            </div>

            <div id="reviewWriteModal" class="modal" style="display:none;">
                <form id="reviewWriteForm" method="post" th:action="@{/member/reviewWrite}" enctype="multipart/form-data">
                    <div class="modal-content">
                        <h2>리뷰 작성</h2>
                        <div class="star_rating">
                            <span class="star on" value="1"></span>
                            <span class="star" value="2"></span>
                            <span class="star" value="3"></span>
                            <span class="star" value="4"></span>
                            <span class="star" value="5"></span>
                        </div>
                        <textarea class="star_box" id="reviewText" name="reviewText" placeholder="리뷰 내용을 작성해주세요." oninput="reviewLimit(this, 100)" ></textarea>
                        <div><input type="file" name="reviewFile" value="이미지넣기"></div>
                        <button type="button" class="btn" onclick="reviewWrite()">리뷰등록</button>
                        <button class="reviewModalClose btn" type="button">닫기</button>
                    </div>
                    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                    <input type="hidden" id="reviewProductOrderId" name="reviewProductOrderId" value="0">
                    <input type="hidden" id="starRatingValue" name="starRatingValue" value="0">
                </form>
            </div>

            <div id="reviewViewModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div id="reviewViewModalContent"></div>
                    <div class="btnFlex">
                        <button class="reviewViewModalClose btn" type="button">닫기</button>
                        <button class="btn btnNone" onclick="reviewReplyWriteModalOpen()" type="button"
                                style="display: none;">
                            리뷰답장하기
                        </button>
                    </div>
                </div>
            </div>

            <div class="section" id="qnaView" style="display: none;">
                <h2>문의한 내용</h2>
                <table>
                    <tr>
                        <th>번호</th>
                        <th>상품명</th>
                        <th>문의제목</th>
                        <th>비고</th>
                    </tr>
                    <th:block th:each="qnaViewList, qnaViewListStat : ${qnaViewList}">
                        <tr>
                            <td th:text="${qnaViewListStat.count}">123</td>
                            <td th:text="${qnaViewList.product_name}">상품이름</td>
                            <td th:text="${qnaViewList.content}">문의제목</td>
                            <td th:if="${qnaViewList.reply == 1}">
                                <button th:onclick="|qnaView('${qnaViewList.id}', '${qnaViewListStat.count}')|">답변보기</button>
                            </td>
                            <td th:if="${qnaViewList.reply == 0}">
                                <p>대기중</p>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5"><div th:id="'qnaViewReplyContent' + ${qnaViewListStat.count}" style="display: none;"></div></td>
                        </tr>
                    </th:block>
                </table>

            </div>

            <!-- 유저등급 level2 -->
            <div class="section" id="product_register" style="display: none;">
                <h2>상품등록</h2>
                <form name="productForm" method="post" th:action="@{/product/insertProduct}" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="maincategory">대분류카테고리 선택</label>
                        <select id="maincategory" name="maincategory" required>
                            <option value="">대분류카테고리를 선택하세요</option>
                            <option th:each="vos_mainCategory : ${vos_mainCategory}" th:value="${vos_mainCategory.id}" th:text="${vos_mainCategory.title}"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="subcategory">서브카테고리 선택</label>
                        <select id="subcategory" name="subcategory" required>
                            <option value="">서브카테고리를 선택하세요</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="brand">브랜드</label>
                        <input type="text" id="brand" name="brand" required>
                    </div>
                    <div class="form-group">
                        <label for="product_name">상품 이름</label>
                        <input type="text" id="product_name" name="product_name" required>
                    </div>
                    <div class="form-group">
                        <label for="product_img">상품 이미지</label>
                        <input type="file" id="product_img" name="product_img" accept=".jpg, .jpeg, .png" multiple required>
                        <p id="fileLimitMessage" style="color: red;"></p>
                        <input type="hidden" id="img1" name="img1">
                        <input type="hidden" id="img2" name="img2">
                        <input type="hidden" id="img3" name="img3">
                        <input type="hidden" id="img4" name="img4">
                        <input type="hidden" id="img5" name="img5">
                    </div>
                    <div class="form-group">
                        <label for="product_img_detail">상세 이미지</label>
                        <input type="file" id="product_img_detail" name="product_img_detail" accept=".jpg, .jpeg, .png" required>
                    </div>
                    <div class="form-group">
                        <label for="price">가격</label>
                        <input type="number" id="price" name="price" required>
                    </div>
                    <div class="form-group">
                        <label for="stock">재고 수</label>
                        <input type="number" id="stock" name="stock" required>
                    </div>

                    <div id="designFields">
                        <label for="design">디자인</label>
                        <div class="form-group design-row">
                            <input type="text" id="design" class="design-input" placeholder="최대 5항목" required>
                            <input type="hidden" id="designData" name="designData">
                            <div class="add-design" id="addDesign">+</div>
                        </div>
                    </div>
                    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                    <input type="button" onclick="productCheck()" value="상품 등록">
                </form>
            </div>

            <div class="section" id="productOrder" style="display: none;">
                <h2>판매관리</h2>
                <table>
                    <thead>
                        <tr>
                            <th>상품명</th>
                            <th>디자인</th>
                            <th>구입수량</th>
                            <th>구입자이름</th>
                            <th>구입자주소</th>
                            <th>구입가격</th>
                            <th>배송상태</th>
                            <th>결재상태</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody th:each="productOrderList, sectionProductOrderListStat : ${productOrderList}">
                        <tr>
                            <td th:text="${productOrderList.productName}">상품이름</td>
                            <td th:text="${productOrderList.design}">디자인</td>
                            <td th:text="${productOrderList.amount}">주문한수량</td>
                            <td th:text="${productOrderList.orderMemberName}">구입자이름</td>
                            <td th:text="${productOrderList.address}">구입자주소</td>
                            <td th:text="${productOrderList.price}">구입한 가격</td>
                            <td th:id="'productOrderStatus_' + ${sectionProductOrderListStat.index}" th:text="${productOrderList.orderStatus}">배송상태</td>
                            <td th:text="${productOrderList.status}">결재상태</td>
                            <td>
                                <button th:if="${productOrderList.orderStatus} == '배송전'"
                                        class="btn" th:productOrderId="${productOrderList.id}"
                                        th:index="${sectionProductOrderListStat.index}"
                                        onclick="sendProduct(this.getAttribute('productOrderId'), this.getAttribute('index'))">
                                    배송
                                </button>
                                <button th:if="${productOrderList.orderStatus} == '환불처리중'"
                                        class="btn" th:productOrderId="${productOrderList.id}"
                                        th:index="${sectionProductOrderListStat.index}"
                                        onclick="refundReason(this.getAttribute('productOrderId'), this.getAttribute('index'))">
                                    환불사유
                                </button>
                                <p th:if="${productOrderList.orderStatus} == '배송완료'">배송완료</p>
                                <p th:if="${productOrderList.orderStatus} == '배송중'">배송중</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="section" id="reviewReply" style="display: none;">
                <h2>리뷰관리</h2>
                <table>
                    <tr>
                        <th>상품명</th>
                        <th>디자인</th>
                        <th>점수</th>
                        <th>구매아이디</th>
                        <th>비고</th>
                    </tr>
                    <tr th:each="reviewReplyList : ${reviewReplyList}">
                        <td th:text="${reviewReplyList.productName}"></td>
                        <td th:text="${reviewReplyList.design}"></td>
                        <td th:text="${reviewReplyList.stars}"></td>
                        <td th:text="${reviewReplyList.mid}"></td>
                        <td>
                            <button class="btn"
                                    th:if="${reviewReplyList.reply == 0}"
                                    th:replyProductOrderId="${reviewReplyList.order_id}"
                                    onclick="befOpenReviewViewModal(this.getAttribute('replyProductOrderId'))">
                                리뷰보기
                            </button>
                            <p th:if="${reviewReplyList.reply == 1}">댓글작성완료</p>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="section" id="qna" style="display: none;">
                <h2>문의관리</h2>
                <table>
                    <tr>
                        <th>번호</th>
                        <th>제목</th>
                        <th>비고</th>
                    </tr>
                    <tr th:each="qnaList, qnaStat : ${qnaList}">
                        <td th:text="${qnaStat.count}">123</td>
                        <td th:if="${qnaList.reply == 0}"
                            th:text="${qnaList.title}"
                            th:productQId="${qnaList.id}"
                            th:reply="${qnaList.reply}"
                            class="qnaTitle">
                            문의제목(답변안함)
                        </td>
                        <td th:if="${qnaList.reply == 1}"
                            th:text="${qnaList.title}"
                            class="qnaTitleEnd">
                            문의내용(답변함)
                        </td>
                        <td>
                            <p th:if="${qnaList.reply == 0}">대기중</p>
                            <p th:if="${qnaList.reply == 1}">답변완료</p>
                        </td>
                    </tr>
                </table>
            </div>

        </div>
    </div>

    <div id="qnaModal" class="modal" style="display: none;">
        <div class="modal-content">
            <label class="form-group" style="margin-bottom: 0px;">문의내용</label>
            <div id="qnaModalContent" class="qnaModalContent"></div>
                <form id="qnaModalForm" method="post" th:action="@{/member/qnaReply}">
                    <label class="form-group" style="margin-bottom: 0px;">답변작성</label>
                    <textarea id="qnaReplyContent" name="qnaReplyContent"></textarea>
                    <div class="modal-footer">
                        <button type="button" class="btn" onclick="qnaCheck()">답변하기</button>
                        <button class="btn qnaModalClose" type="button">닫기</button>
                        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                        <input type="hidden" id="productQId" name="productQId" value="0">
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="reviewReplyWriteModal" class="modal" style="display: none;">
        <form id="reviewReplyWriteForm" method="post" th:action="@{/member/reviewReplyWrite}">
            <div class="modal-content">
                <h2>리뷰답글쓰기</h2>
                <textarea id="reviewReplyText" name="reviewReplyText" class="star_box" placeholder="리뷰 내용을 작성해주세요."></textarea>
                <div class="btnFlex">
                    <button class="btn reviewReplyWriteModalClose" type="button">닫기</button>
                    <button class="btn" onclick="reviewReplyCheck()" type="button">작성하기</button>
                </div>
                <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                <input type="hidden" name="reviewId" id="reviewId">
            </div>
        </form>
    </div>

    <!-- 환불거절 사유 창 -->
    <div id="refundRefuseModal" class="modal" style="display: none;">
        <span class="close-btn">&times;</span>
        <form id="sendRefundRefuseForm" method="post" th:action="@{/member/refundRefuse}">
            <div class="modal-content">
                <p>환불사유</p>
                <textarea rows="7" cols="40" maxlength="50" oninput="updateCharCount()" id="refundRefuseTextarea" name="refundRefuseTextarea"></textarea>
                <p>남은 글자 수: <span id="reFuseCharCount">50</span></p>
                <button class="btn" type="button" onclick="sendRefundRefuse()">환불거절</button>
                <button class="closeRefundRefuseModal btn" type="button">닫기</button>
            </div>
            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
            <input type="hidden" id="hidProductOrderId" name="productOrderId">
        </form>
    </div>

    <!--  환불사유창.. 여기서 환불해줄지 환불거절할지 결정  -->
    <div id="refundReasonModal" class="modal" style="display: none;">
        <span class="close-btn">&times;</span>
        <div class="modal-content">
            <div id="refundReason"></div>
            <button class="btn" onclick="refundRefuse()">환불거절</button>
            <button class="btn" onclick="refundOk()">환불</button>
        </div>
    </div>

    <div id="refundRefuseReasonModal" class="modal" style="display: none;">
        <span class="close-btn">&times;</span>
        <div class="modal-content">
            <div id="refundRefuseReason" style="margin-bottom:10px;"></div>
            <input type="hidden" id="hidProductOrderIdForComplete" name="productOrderId">
            <p>환불거절 사유가 논리적이지 않거나 사유가 납득이 되지 않는다면 <span style="color:red;">구매결정하시지 마시고</span> 043-123-5678로 문의주세요.</p>
            <button class="btn" onclick="completeOrderCheck()" id="completeOrderCheck">구매결정</button>
            <button class="btn closeRefundRefuseReasonModal" onclick="">닫기</button>
        </div>
    </div>

    <script>
        'use strict'

        // 모달 관련 요소 선택
        const modal = document.getElementById('pwdSetModal');
        const refundModal = document.getElementById('refundModal');
        const closeModalBtn = document.querySelector('.close-btn');
        const closeModal = document.querySelector('.closeModal');
        const refundRefuseModal = document.getElementById('refundRefuseModal');
        const closeRefundRefuseModal = document.querySelector('.closeRefundRefuseModal');
        const refundReasonModal = document.getElementById('refundReasonModal');
        const refundRefuseReasonModal = document.getElementById('refundRefuseReasonModal');
        const closeRefundRefuseReasonModal = document.querySelector('.closeRefundRefuseReasonModal');
        const reviewWriteModal = document.getElementById('reviewWriteModal');
        const reviewModalClose = document.querySelector('.reviewModalClose');
        const reviewViewModal = document.getElementById('reviewViewModal');
        const reviewViewModalClose = document.querySelector('.reviewViewModalClose');
        const reviewReplyWriteModal = document.getElementById('reviewReplyWriteModal');
        const reviewReplyWriteModalClose = document.querySelector('.reviewReplyWriteModalClose');
        const reviewReplyViewModal = document.getElementById('reviewReplyViewModal');
        const reviewReplyViewModalClose = document.querySelector('.reviewReplyViewModalClose');
        const qnaModal = document.getElementById('qnaModal');
        const qnaModalClose = document.querySelector('.qnaModalClose');

        // 모달 닫기 함수 (닫기 버튼 클릭 시)
        closeModalBtn.addEventListener("click", () => {
            modal.style.display = 'none';
        });

        // 모달내부 닫기버튼
        closeModal.addEventListener('click', function () {
            refundModal.style.display = 'none';
        });

        closeRefundRefuseModal.addEventListener('click', function () {
            refundRefuseModal.style.display = 'none';
        });

        closeRefundRefuseReasonModal.addEventListener('click', function () {
            refundRefuseReasonModal.style.display = 'none';
        });

        // 모달 닫기 함수 (배경 클릭 시)
        window.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
            else if(e.target === refundModal) {
                refundModal.style.display = 'none';
            }
            else if(e.target === refundRefuseModal) {
                refundRefuseModal.style.display = 'none';
            }
            else if(e.target === refundRefuseReasonModal) {
                refundRefuseReasonModal.style.display = 'none';
            }
            else if(e.target === reviewWriteModal) {
                reviewWriteModal.style.display = 'none';
            }
        });

        // 모달 열기
        function openPwdSetModal(){
             modal.style.display = 'flex';
        }

        function refundRequest(productOrderId, index){
            let orderStatusCheck = document.getElementById('orderStatus_' + index).textContent.trim();
            if(orderStatusCheck != '배송중'){
                alert('상품이 배송중일때 환불처리를 할 수 있습니다.');
                return;
            }
            refundModal.style.display = 'flex';

            document.getElementById('productOrderId').value = productOrderId;
        }

        function pwdSet(){
            let pwd1 = document.getElementById("pwd1").value.trim();
            let pwd2 = document.getElementById("pwd2").value.trim();

            if(pwd1 == "" || pwd2 == ""){
                alert("모든칸을 채우셔야합니다.");
            }
            document.getElementById("pwd").value = pwd2;
            pwdSetModalForm.submit();
        }

        // 비밀번호 수정
        let pwd1 = document.getElementById("pwd1");
        let pwd2 = document.getElementById("pwd2");
        let pwd1Msg = document.getElementById("pwd1Msg");
        let pwd2Msg = document.getElementById("pwd2Msg");
        let pwdPattern = /^[a-z\d!@#$%^&*]{8,}$/;

        pwd1.addEventListener('input', function() {
            if(!pwdPattern.test(pwd1.value)) pwd1Msg.textContent = "비밀번호는 최소 8자 이상의 소문자와 숫자 그리고 특수문자들을 사용할 수 있습니다.";
            else pwd1Msg.textContent = "";
        });

        pwd2.addEventListener('input', function() {
            if (pwd2.value !== pwd1.value) pwd2Msg.textContent = "비밀번호가 일치하지 않습니다.";
            else pwd2Msg.textContent = "";
        });

        function showSection(section) {
            const sections = document.querySelectorAll('.section');

            // 선택된 섹션의 ID를 확인합니다.
            let isProductSection = (
                section === 'product_register' ||
                section === 'productOrder' ||
                section === 'reviewReply' ||
                section === 'qna'
            );

            if(isProductSection){
                let sLevel = [[${level}]];
                if(sLevel < 2) {
                    alert("계좌를 등록하시면 이용 할 수 있습니다.");
                    return;
                }
            }

            sections.forEach((sec) => {
                    sec.style.display = 'none';
            });

            const targetSection = document.getElementById(section);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            document.getElementById(section).style.display = 'block';

            // URL 해시를 변경하여 현재 섹션 상태를 저장합니다.
            window.location.hash = section;
        }

        // 페이지가 로드될 때, URL 해시를 확인하여 해당 섹션을 자동으로 표시합니다.
        window.addEventListener('load', () => {
            const hash = window.location.hash.substring(1); // 해시 값에서 #을 제거합니다.
            if (hash) {
                showSection(hash);
            }
        });

        function editProfile(){
            const accountNumDisplay = document.querySelector('.account_num_display');
            accountNumDisplay.style.display = 'block';
        }

        function editAccount_num(){
            const sendRefundForm = document.getElementById('accountForm');

            let account_num = document.getElementById("account_num").value.trim();
            if(account_num == "") {
                alert("계좌번호를 적어주세요.");
                return
            }
            sendRefundForm.submit();
        }
    </script>
    <script>
        'use strict';
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        let designCount = 1;
        const maxDesignCount = 5;

        // 디자인 항목 추가 버튼 기능
        function addDesignField() {
            if (designCount >= maxDesignCount) return; // 디자인 항목 최대치 제한
            designCount++;

            // 기존에 있던 + 버튼과 - 버튼 제거
            const currentAddButton = document.querySelector('.add-design');
            if (currentAddButton) {
                currentAddButton.remove();
            }

            const currentRemoveButton = document.querySelector('.remove-design');
            if (currentRemoveButton) {
                currentRemoveButton.remove();
            }

            // 새로운 디자인 항목 추가
            const designDiv = document.createElement('div');
            designDiv.classList.add('form-group', 'design-row');
            designDiv.innerHTML = `
                <input type="text" class="design-input" placeholder="디자인 ${designCount}" required>
                <div class="remove-design">-</div>
                <div class="add-design">+</div>
            `;

            // 새로 추가된 디자인 항목의 +, - 버튼에 기능 적용
            designDiv.querySelector('.add-design').addEventListener('click', addDesignField);
            designDiv.querySelector('.remove-design').addEventListener('click', function() {
                removeDesignField(designDiv);
            });

            document.getElementById('designFields').appendChild(designDiv);

            updateRemoveButtonVisibility();
        }

        // 디자인 항목 제거 기능
        function removeDesignField(designDiv) {
            designDiv.remove();
            designCount--;

            // 모든 디자인 항목에서 +, - 버튼 제거
            const allAddButtons = document.querySelectorAll('.add-design');
            const allRemoveButtons = document.querySelectorAll('.remove-design');
            allAddButtons.forEach(button => button.remove());
            allRemoveButtons.forEach(button => button.remove());

            // 마지막 디자인 항목에만 +, - 버튼 추가
            const lastDesignRow = document.querySelectorAll('.design-row');
            if (lastDesignRow.length > 0) {
                const lastRow = lastDesignRow[lastDesignRow.length - 1];

                const removeButton = document.createElement('div');
                removeButton.classList.add('remove-design');
                removeButton.innerText = '-';
                removeButton.addEventListener('click', function() {
                    removeDesignField(lastRow);
                });

                const addButton = document.createElement('div');
                addButton.classList.add('add-design');
                addButton.innerText = '+';
                addButton.addEventListener('click', addDesignField);

                lastRow.appendChild(removeButton);
                lastRow.appendChild(addButton);
            }
            updateRemoveButtonVisibility();
        }

        // 마지막 디자인 항목이 하나일 경우 - 버튼 숨기기
        function updateRemoveButtonVisibility() {
            const designRows = document.querySelectorAll('.design-row');
            const removeButton = designRows[designRows.length - 1].querySelector('.remove-design');
            if (designRows.length === 1) {
                removeButton.style.display = 'none';
            } else {
                removeButton.style.display = 'inline-block';
            }
        }

        // 처음 디자인 항목의 + 버튼에 기능 적용
        document.getElementById('addDesign').addEventListener('click', addDesignField);

        // 카테고리 선택 시 option 변화
        document.getElementById("maincategory").addEventListener("change", function() {
            const mainCategoryId = this.value;

            const subCategorySelect = document.getElementById("subcategory");
            subCategorySelect.innerHTML = '<option value="">서브카테고리를 선택하세요</option>'; // 초기화

            if (mainCategoryId != "") {
                fetch('/member/getSubCategories',{
                    method: "POST",
                    headers: {
                        [csrfHeader]: csrfToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mainCategoryId: mainCategoryId })
                })
                .then(response => response.json())
                .then(data => {
                    data.forEach(subCategory => {
                        const option = document.createElement("option");
                        option.value = subCategory.id; // 소분류 ID
                        option.textContent = subCategory.title; // 소분류 제목
                        subCategorySelect.appendChild(option); // 소분류 선택 박스에 추가
                    });
                })
                .catch(error => {
                    console.error("소분류를 가져오는 중 에러 발생:", error);
                });
            }
        });

        // 파일 5개까지 선택할수 있도록 제한
        product_img.addEventListener("change", function () {
            // 선택된 파일의 개수를 확인합니다.
            const files = product_img.files;

            // 선택된 파일 개수가 5개를 초과하는 경우
            if (files.length > 5) {
                // 초과한 경우 파일 입력을 초기화합니다.
                product_img.value = "";
                // 사용자에게 경고 메시지를 표시합니다.
                fileLimitMessage.textContent = "최대 5개의 파일만 업로드할 수 있습니다.";
            } else {
                // 제한 내에 있는 경우 메시지를 지웁니다.
                fileLimitMessage.textContent = "";
            }
        });

        function productCheck() {
            let maincategory = document.getElementById("maincategory").value;
            let subcategory = document.getElementById("subcategory").value;
            let brand = document.getElementById("brand").value.trim();
            let product_name = document.getElementById("product_name").value.trim();
            let product_img = document.getElementById("product_img");
            let product_img_detail = document.getElementById("product_img_detail");
            let price = document.getElementById("price").value;
            let stock = document.getElementById("stock").value;

            // 디자인 항목 가져오기
            let designInputs = document.querySelectorAll(".design-input");
            let designs = [];

            // 디자인 입력값을 배열에 추가
            for (let i = 0; i < designInputs.length; i++) {
                const input = designInputs[i];
                // 공백 입력값은 추가하지 않도록 필터링
                if (input.value.trim() !== "") {
                    designs.push(input.value.trim());
                }
            }

            // 디자인을 JSON 문자열로 변형
            const designsJson = JSON.stringify(designs);
            document.getElementById('designData').value = designsJson;

            // 상품이미지 처리
            const productImgs = product_img.files; // FileList
            const productImgDetails = product_img_detail.files[0]; // 단일 파일

            // 상품 이미지 파일 처리
            for (let i = 0; i < productImgs.length; i++) {
                document.getElementById(`img${i + 1}`).value = productImgs[i].name;
            }

            // 상세 이미지 파일 처리
            if (productImgDetails) {
                console.log('선택한 상세 이미지:', productImgDetails.name);
                console.log('파일 크기:', productImgDetails.size);
            }

            if(maincategory == "" || subcategory == ""){
                alert("등록하고자하는 분류를 선택해주세요.");
                return
            }
            else if(brand == ""){
                alert("여러분의 고유의 브랜드명을 적어주세요.");
                return
            }
            else if(product_name == ""){
                alert("상품명을 입력해주세요.");
                return
            }
            else if(price == ""){
                alert("가격을 입력해주세요.");
                return
            }
            else if(stock == ""){
                alert("현재 물건의 수량을 입력해주세요.");
                return
            }
            else if(designsJson == ""){
                alert("판매하는 물품의 디자인명을 입력해주세요.");
                return
            }
            else productForm.submit();


            // 결과 확인 (디버깅 용도)
            // console.log(designsJson);
        }
    </script>
    <script>
        'use strict'

        function completeOrder(productOrderId, productId, amount){
            let item = {
                productOrderId : productOrderId,
                productId : productId,
                amount : amount
            };

            fetch('/member/completeOrder',{
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(item)
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    alert('주문완료처리되었습니다.');
                    location.reload();
                }
            })
            .catch(error => {
                console.error(error);
            });
        }

        function updateCharCount() {
            let textarea = document.getElementById('refundTextarea');
            let charCount = document.getElementById('charCount');
            charCount.textContent = 50 - textarea.value.length;
        }

        function sendRefund(){
            let refundTextarea = document.getElementById('refundTextarea').value.trim();
            if(refundTextarea == '') alert('환불사유를 입력해주세요.');

            refundModal.submit();
        }

        function refundRefuse(){
            refundReasonModal.style.display = 'none';
            refundRefuseModal.style.display = 'flex';
        }

        function sendRefundRefuse(){
            let refundRefuseTextarea = document.getElementById('refundRefuseTextarea').value.trim();
            if(refundRefuseTextarea == '') alert('환불거부 사유를 입력해주세요.');

            let sendRefundRefuseForm = document.getElementById('sendRefundRefuseForm');
            sendRefundRefuseForm.submit();
        }

        function refundReason(productOrderId, index){
            let productOrderStatusCheck = document.getElementById('productOrderStatus_' + index).textContent.trim();
            if(productOrderStatusCheck != '환불처리중'){
                alert('상품이 환불처리중일때 환불거절을 할 수 있습니다.');
                return;
            }

            fetch('/member/refundReason',{
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ productOrderId : productOrderId })
            })
            .then(response => response.json())
            .then(data => {
                if(data.success){
                    let content = data.content;
                    document.getElementById('refundReason').textContent = content;
                    document.getElementById('hidProductOrderId').value = productOrderId;
                    refundReasonModal.style.display = 'flex';
                }
                else alert('거절사유를 가져오는 도중 에러발생.');
            })
            .catch(error => {
                console.error(error);
            });
        }

        function refundRefuseReason(productOrderId, index){
            let orderStatusCheck = document.getElementById('orderStatus_' + index).textContent.trim();
            if(orderStatusCheck != '환불거부'){
                alert('상품이 환불거부 상태일때 사용할 수 있는 버튼입니다.');
                return;
            }

            fetch('/member/refundRefuseReason',{
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ productOrderId : productOrderId })
            })
            .then(response => response.json())
            .then(data => {
                if(data.success){
                    let content = data.content;
                    document.getElementById('refundRefuseReason').textContent = content;
                    document.getElementById('hidProductOrderIdForComplete').value = productOrderId;
                    refundRefuseReasonModal.style.display = 'flex';
                }
                else alert('거절사유를 가져오는 도중 에러발생.');
            })
            .catch(error => {
                console.error(error);
            });
        }

        function completeOrderCheck(){
            let productOrderId = document.getElementById('hidProductOrderIdForComplete').value;
            const completeOrderCheckButton = document.getElementById('completeOrderCheck');
            completeOrderCheckButton.addEventListener('click', () => completeOrder(productOrderId));
        }

        function sendProduct(productOrderId, index){
            let productOrderStatusCheck = document.getElementById('productOrderStatus_' + index).textContent.trim();
            if(productOrderStatusCheck != '배송전'){
                alert('상품이 배송전일때 배송버튼을 이용할 수 있습니다.');
                return;
            }

            fetch('/member/sendProduct',{
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ productOrderId : productOrderId })
            })
            .then(response => response.json())
            .then(data => {
                if(data.success){
                    alert('배송처리했습니다.');
                    location.reload();
                }
                else alert('배송처리중 에러발생.');
            })
            .catch(error => {
                console.error(error);
            });
        }
    </script>
    <script>
        'use strict';

        function deleteWishList(productId){
            fetch('/member/deleteWishList',{
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ productId : productId })
            })
            .then(response => response.json())
            .then(data => {
                if(data.loginOk){
                    if(data.success){
                        alert('위시리스트에서 삭제되었습니다.');
                        location.reload();
                    }
                    else alert('위시리스트 삭제중 오류발생');
                }
                else{
                    alert('세션완료. 로그인하셔야 사용할 수 있는 기능입니다.');
                    console.log('loginOk--false');
                }
            })
            .catch(error => {
                console.error(error);
            });
        }
    </script>
    <script src="/js/memberP_review.js"></script>
    <script src="/js/memberP_qna.js"></script>
</body>
</html>